# UPGRADE FROM 3.5 to 3.6

## [NodeSearchBundle][SearchBundle] have undergone major refactoring.

##### Website with a default SearchPage without changes to the underlying code.
These websites will have to do 2 things to become fully operational again.
First they have to set up their indices again. This can be achieved with the following commands.
```bash
 app/console kuma:search:setup && app/console kuma:search:populate full
```
And the twig files that were generated by the ```app/console kuma:generate:search``` have to be fixed. All references to facets in these files have to be rewritten to aggregations. In this commit you can see exactly how to do that. 5e4a7c162fc6f87bbaca058b697651f5d92bb4c3
##### Changed interfaces and implementations
If you have overwritten, implemented, extended any of these interfaces and classes you should check if you need to do some rewriting of your custom code.

***src/Kunstmaan/SearchBundle/Search/AnalysisFactoryInterface***
* Method setupLanguages has been removed since you want create 1 analysis per index/language.
* Getter and Setter for the variable stopwords have been removed. They are not used in the default implementation and it does not make sense to have getters and setters in an interface. If you want to create your own AnalysisFactory implementation which uses a custom list of stopwords you can inject that list however you want.
* Method addStemmerFilter($language) has been added. Usually a better alternative for NGrams.

***src/Kunstmaan/SearchBundle/Search/AnalysisFactory***
* Names of the analyzers have been changed so that the index can automatically recognize what to use them for. "index_analyzer" is changed to "default" and suggestion_analyzer has been changed to "default_search".

***src/Kunstmaan/NodeSearchBundle/Search/SearcherInterface***
* Parameter $lang has been removed from the method defineSearch. It does not make sense to provide this parameter anymore since the index in the query is already language specific, and thus no need to filter on this in the query.

***src/Kunstmaan/NodeSearchBundle/Search/AbstractElasticaSearcher***
* Parameter $lang has been removed from the method defineSearch. It does not make sense to provide this parameter anymore since the index in the query is already language specific, and thus no need to filter on this in the query.
* Search function has been altered to search in the language specific index.

***src/Kunstmaan/NodeSearchBundle/Configuration/NodePagesConfiguration***
* Default behaviour for createIndex() creates a specific index for each configured locale
* Default behaviour for populateIndex() has been altered to reflect the new index structure
* Mapping _boost has been removed
* Mapping index_analyzer and suggestion_analyzer are gone because the index now has to detect the function of the analyzers based on their name.

***src/Kunstmaan/NodeSearchBundle/Services/SearchService***
* The applySearchParams function does not apply facets to the query anymore.

***src/Kunstmaan/NodeSearchBundle/pagerFanta/Adapter/SearcherRequestAdapterInterface***
* Method getFacets() has been removed.

***src/Kunstmaan/NodeSearchBundle/PagerFanta/Adapter/SearcherRequestAdapter***
* All references to Facets have been removed.

***src/Kunstmaan/NodeSearchBundle/Search/NodeSearcher***
* Applying extra boost to the title field should not be hardcoded in the query because it is easily configured in the field mapping and hardcoding this would always override user configuration.
* Extra rescoring step added to the queries as an alternative to document boosting.

***Configuration***
* Document field 'lang' has been removed from the default mapping configuration.
* Document field 'contentanalyzer' has been removed from the default mapping configuration.
* Parameter 'index_name' is not available anymore. Has been with the option 'copy_to'

